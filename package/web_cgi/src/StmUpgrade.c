#include "stdio.h"#include "string.h"#include "stdlib.h"#include "dirent.h"#include <wchar.h>#include <assert.h>#include <errno.h>#include <stdlib.h>             #include <ctype.h>#include <time.h>           #include <pwd.h>#include <grp.h>#include <unistd.h>#include <fcntl.h>#include <limits.h>      #include <setjmp.h>#include <netinet/in.h>#include <linux/wireless.h>#include <sys/ioctl.h>#include <sys/types.h>#include <sys/mman.h>#include <sys/types.h>        #include <sys/socket.h>      #include <sys/stat.h>         #include "socket_uart.h"//#include "apmib.h"     //#define watchdog_9331 1static char filePath[256]="/tmp/stm8.s19";#define rtl_encryp_control "/proc/rtl_encryp_control"#define upload_bin_start  7#define get_power_level_num  1#define upload_bin_end  8#define READ_SIZE   (1024)#define WINIE6_STR	"/octet-stream\x0d\x0a\0x0d\0x0a"#define LINUXFX36_FWSTR "/x-ns-proxy-autoconfig\x0d\x0a\0x0d\0x0a"#define MACIE5_FWSTR	"/macbinary\x0d\x0a\0x0d\0x0a"#define OPERA_FWSTR	"/x-macbinary\x0d\x0a\0x0d\0x0a"#define GOOGLE_FWSTR	"/plain\x0d\x0a\0x0d\0x0a"#define LINE_FWSTR	"\x0d\x0a\0x0d\0x0a"#define CONF_HEADER                     ((char *)"conf")int find_head_offset(char *upload_data){	int head_offset=0 ;	char *pStart=NULL;	int iestr_offset=0;	char *dquote;	char *dquote1;		if (upload_data==NULL) {		//fprintf(stderr, "upload data is NULL\n");		return -1;	}	pStart = strstr(upload_data, WINIE6_STR);	if (pStart == NULL) {		pStart = strstr(upload_data, LINUXFX36_FWSTR);		if (pStart == NULL) {			pStart = strstr(upload_data, MACIE5_FWSTR);			if (pStart == NULL) {				pStart = strstr(upload_data, OPERA_FWSTR);				if (pStart == NULL) {					pStart = strstr(upload_data, GOOGLE_FWSTR);					if (pStart == NULL) {						pStart = strstr(upload_data, "filename=");						if (pStart == NULL) {							return -1;						}						else {							dquote =  strstr(pStart, "\"");							if (dquote !=NULL) {								dquote1 = strstr(dquote, LINE_FWSTR);								if (dquote1!=NULL) {									iestr_offset = 4;									pStart = dquote1;								}								else {									return -1;								}							}							else {								return -1;							}						}					}					else{						iestr_offset = 10;					}					}				else {					iestr_offset = 16;				}			} 			else {				iestr_offset = 14;			}		}		else {			iestr_offset = 26;		}	}	else {		iestr_offset = 17;	}	//fprintf(stderr,"####%s:%d %d###\n",  __FILE__, __LINE__ , iestr_offset);	head_offset = (int)(((unsigned long)pStart)-((unsigned long)upload_data)) + iestr_offset;//	printf("<br>head_offset=%d \n",head_offset);	return head_offset;}int stm8_upgrade(void){	int ret = 0;	socket_uart_cmd_t g_uart_cmd;		g_uart_cmd.regaddr = SOCKET_UART_STM8_UPLOAD;	ret = SocketUartClientStart(&g_uart_cmd);	if(ret < 0)	{		printf("stm8 upgrade error, error code = %d \r\n");		ret = -1;		}	else	{		//printf("stm8 upgrade success\n");	}	return ret;}int main(){	FILE *fileBuf=NULL;	int head_offset=0;	int len_no_header = 0;	char *upload_data = NULL;	char *read_offset = NULL;	char *header = NULL;	int upload_len = 0;	int true_len = 0;	int read_byte = 0;	int f_size_r = 0, f_size_w = 0;	int try_times = 0;	int i;	int tail_count = 0;	char errorBuf[200]="";	unsigned char linebuf[250];	int ret = 0;	printf("Content-type: %s\r\n\r\n", "text/html");	fprintf(stdout,"<html><title>stm8 upgrade</title>\n");	fprintf(stdout,"<body>\n");	upload_len=atoi(getenv("CONTENT_LENGTH"));	upload_data=(char *)malloc(upload_len + 1);	if(upload_data==NULL){		printf("STM8 upgrade  error\n");		goto error;	}	//fread(upload_data,1,upload_len,stdin);	read_offset = upload_data;	while(read_byte < upload_len)	{		f_size_r = fread(read_offset,1,READ_SIZE,stdin);		if(f_size_r == 0){			try_times++;			if(try_times > 10000){//10s no receive data				goto error;			}			usleep(1000);		}		else if(f_size_r < 0){			goto error;		}		else{			read_byte += f_size_r;			read_offset += f_size_r;			try_times = 0;		}	}	unsigned char isValidfw = 0;	head_offset = find_head_offset(upload_data);	if(head_offset == -1) {		printf("head_offset  error\n");		goto error;	}	header = upload_data+head_offset;	/*   cut the tail */	len_no_header=upload_len-head_offset;	if( header[len_no_header-1]== 0x0a && header[len_no_header-2]== 0x0d )	{		i=len_no_header-2;		while(header[i-1]!=0x0a && header[i-2]!=0x0d )		{			tail_count++;			i--;		}	}	else	{		printf("there is a error,please reboot the device and upgrade again! <br>");		goto error;	}	tail_count+=4;	true_len=upload_len-head_offset-tail_count;	fileBuf = fopen(filePath, "w");	if(fileBuf== NULL)	{			printf("fileBuf  null fjsafkasjlk\n");			goto error;	}	//		printf("%s \n",(upload_data+head_offset));	//fwrite((upload_data+head_offset),(upload_len-head_offset),1, fileBuf);	f_size_w = fwrite(header,1,true_len,fileBuf);	fclose(fileBuf);#ifdef watchdog_9331system("killall watchdog");#endif		system("killall check_reset");	ret = stm8_upgrade();	if(ret < 0)	{		printf("stm8 upgrade fail\n");		goto error;	}			printf("<br>stm8 upgrade successful :)<br>");	fprintf(stdout,"</body>\n");	fprintf(stdout,"\n</html>\n");	return 0;error:	if(upload_data!=NULL)		free(upload_data);	printf("<br>stm8 upgrade failed :(<br>");	fprintf(stdout,"</body>\n");	fprintf(stdout,"\n</html>\n");	return -1;}